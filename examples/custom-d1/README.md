# Custom Adapter with D1 + Drizzle Example

This example shows how to use `hono-api-key` with Cloudflare D1 via Drizzle ORM.

## Project layout

- `src/db/schemas/api-keys.ts` – Drizzle schema for API keys
- `src/db/index.ts` – D1/Drizzle connector (`initDbConnect`)
- `src/utils/adapter-database.ts` – Example D1-backed adapter implementing `StorageAdapter`
- `src/index.ts` – Hono app wiring the adapter + middleware
- `drizzle.config.ts` – Drizzle config for migration generation
- `migrations/` – SQL migrations generated by Drizzle
- `wrangler.jsonc` – Worker config with D1 binding

## Configure D1

1. Create a D1 database and bind it in `wrangler.jsonc` (replace IDs/names as needed).
2. Generate the initial SQL migration from the Drizzle schema:

```bash
pnpm dlx drizzle-kit generate
```

3. Apply migrations to your D1 database:

<details>
  <summary><strong>Apply to local DB</strong></summary>

```bash
pnpm dlx wrangler d1 migrations apply hono-api-key-d1-example
```

</details>

<details>
  <summary><strong>Apply to remote DB</strong></summary>

```bash
pnpm dlx wrangler d1 migrations apply hono-api-key-d1-example --remote
```

</details>

If your DB binding name differs, update the command accordingly.

## Run locally

```bash
pnpm dlx wrangler dev
```

The server will start on `http://127.0.0.1:8787`.

## Deploy

Deploy to Cloudflare Workers:

```bash
pnpm dlx wrangler deploy --minify
```

## Example Routes

- `POST /create-api-key` – Create a key
  - Body (optional): `{ ownerId?: string, name?: string, rateLimit?: { windowMs, maxRequests } | null }`
- `GET /secure` – Protected route requiring a valid API key
  - Use query: `?api_key=THE_KEY`
  - Or header: `x-api-key: THE_KEY`

## Notes

- The example adapter demonstrates how to persist API keys and rate-limiting state in a single D1 table using JSON columns.
- Update `src/utils/adapter-database.ts` if you need a different schema or storage strategy.
